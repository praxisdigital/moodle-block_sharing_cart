{"version":3,"file":"element.min.js","sources":["../../../../src/app/block/course/element.js"],"sourcesContent":["import {getCurrentCourseEditor} from \"core_courseformat/courseeditor\";\n\n/**\n * @typedef {import(\"core_courseformat/factory\").BaseFactory} BaseFactory\n * @typedef {import(\"core_courseformat/local/courseeditor/courseeditor\").CourseEditor} CourseEditor\n */\n\n/**\n * @typedef Section\n * @property {number} id\n * @property {number} section\n * @property {number} number\n * @property {string} title\n * @property {boolean} hassummary\n * @property {string} rawtitle\n * @property {string[]} cmlist\n * @property {boolean} visible\n * @property {string} sectionurl\n * @property {boolean} current\n * @property {boolean} indexcollapsed\n * @property {boolean} contentcollapsed\n * @property {boolean} hasrestrictions\n * @property {boolean} bulkeditable\n * @property {string|null} component\n * @property {number|null} itemid\n */\n\n/**\n * @typedef CourseModule\n * @property {number} id\n * @property {string} anchor\n * @property {string} name\n * @property {boolean} visible\n * @property {boolean} stealth\n * @property {string} sectionid\n * @property {number} sectionnumber\n * @property {boolean} uservisible\n * @property {boolean} hascmrestrictions\n * @property {string} modname\n * @property {number} indent\n * @property {number} groupmode\n * @property {string} module\n * @property {string} plugin\n * @property {boolean} delegatesection\n * @property {boolean} accessvisible\n * @property {string} url\n * @property {boolean} istrackeduser\n * @property {boolean} allowstealth\n */\n\nexport default class CourseElement {\n    /**\n     * @type {BaseFactory}\n     */\n    #baseFactory;\n\n    /**\n     * @type {BlockElement}\n     */\n    #blockElement;\n\n    /**\n     * @type {HTMLElement}\n     */\n    #element;\n\n    /**\n     * @type {HTMLElement|null}\n     */\n    #clipboard = null;\n\n    /**\n     * @type {AbortController}\n     */\n    #clipboardTargetListenerAbortController = new AbortController();\n\n    /**\n     * @type {CourseEditor}\n     */\n    reactive;\n\n    /**\n     * @param {BaseFactory} baseFactory\n     * @param {BlockElement} blockElement\n     * @param {HTMLElement} element\n     */\n    constructor(baseFactory, blockElement, element) {\n        this.#baseFactory = baseFactory;\n        this.#blockElement = blockElement;\n        this.#element = element;\n        this.reactive = getCurrentCourseEditor();\n    }\n\n    async renderClipboard() {\n        this.#clipboard = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/course/clipboard',\n            {}\n        );\n\n        this.#element.prepend(this.#clipboard);\n\n        const clearClipboardButton = this.#clipboard.querySelector('[data-action=\"clear-clipboard\"]');\n        clearClipboardButton.addEventListener(\n            'click',\n            this.onClearClipboard.bind(this)\n        );\n    }\n\n    /**\n     * @param {Event} e\n     */\n    onClearClipboard(e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        this.clearClipboard();\n    }\n\n    clearClipboard() {\n        this.#clipboard.classList.add('d-none');\n        this.clearClipboardTargets();\n\n        this.#blockElement.clearClipboard();\n    }\n\n    async reRenderClipboard(){\n        this.clearClipboard();\n        await this.renderClipboard();\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    updateClipboard(item) {\n        this.#clipboard.classList.add('d-none');\n\n        const clipboardItemInfo = this.#clipboard.querySelector('.info');\n        clipboardItemInfo.innerHTML = item.getItemInfo().innerHTML;\n\n        this.#clipboard.classList.remove('d-none');\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async updateClipboardTargets(item) {\n        const element = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/course/clipboard_target',\n            {}\n        );\n\n        this.#clipboardTargetListenerAbortController.abort();\n        this.#clipboardTargetListenerAbortController = new AbortController();\n\n        this.#element.querySelectorAll('[data-for=\"cmlist\"],[data-for=\"course_sectionlist\"]').forEach((section) => {\n\n            let clipboardTarget = null;\n            let sectionId = null;\n\n            if(section.matches('[data-for=\"course_sectionlist\"]')){\n\n                const courseSectionsElementList = section.querySelectorAll('.section-item ul[data-for=\"cmlist\"]');\n\n                if(!courseSectionsElementList){return;}\n\n                courseSectionsElementList.forEach((courseSectionElement) => {\n\n                    if(!this.isSectionClipboardTargetEligible(courseSectionElement,item)) return;\n\n                    clipboardTarget = courseSectionElement.querySelector('.clipboard_target') ?? element.cloneNode(true);\n                    courseSectionElement.prepend(clipboardTarget);\n                    sectionId = courseSectionElement.closest('[data-for=\"section\"]').dataset.id;\n\n                    clipboardTarget.classList.remove('hidden');\n                    clipboardTarget.parentElement.classList.remove('hidden');\n                    clipboardTarget.addEventListener(\n                        'click',\n                        this.#blockElement.confirmImportBackupFromSharingCart.bind(this.#blockElement, item, sectionId),\n                        {\n                            signal: this.#clipboardTargetListenerAbortController.signal\n                        }\n                    );\n                })\n\n                return;\n            }\n\n            if(!this.isSectionClipboardTargetEligible(section,item)) return;\n\n            clipboardTarget = section.querySelector('.clipboard_target') ?? element.cloneNode(true);\n            section.prepend(clipboardTarget);\n            sectionId = section.closest('[data-for=\"section\"]').dataset.id;\n\n            clipboardTarget.classList.remove('hidden');\n            clipboardTarget.parentElement.classList.remove('hidden');\n            clipboardTarget.addEventListener(\n                'click',\n                this.#blockElement.confirmImportBackupFromSharingCart.bind(this.#blockElement, item, sectionId),\n                {\n                    signal: this.#clipboardTargetListenerAbortController.signal\n                }\n            );\n        });\n    }\n\n    /**\n     * Checks whether the section is allowed to have a clipboardTarget button prepended.\n     * For example, subsections are not eligible as a clipboard target if the clipboard is a subsection.\n     * @param {Element} section\n     * @param {ItemElement} item\n     * @returns {boolean}\n     */\n    isSectionClipboardTargetEligible(section,item){\n\n        //Has already been made a clipboardTarget.\n        if (section.querySelector('.clipboard_target')) {\n            return false;\n        }\n        //Sections can always we clipboardTargets if the item is not a subsection or section.\n        if(!item.isSubsection() && !item.isSection()) return true;\n\n        const parentActivityElement = section.closest('[data-region=\"activity-card\"]')\n        //Sections can never be clipboardTargets if the item is a subsection or section.\n        if(parentActivityElement) return false;\n\n        return true;\n    }\n\n    /**\n     * @param {Number} sectionId\n     * @returns {String}\n     */\n    getSectionName(sectionId) {\n        const section = this.reactive.state.section.get(sectionId);\n\n        return section.title ?? 'Unknown';\n    }\n\n    /**\n     * @param {Number} sectionId\n     * @returns {Array<string>}\n     */\n    getSectionCourseModules(sectionId) {\n        return this.reactive.state.section.get(sectionId).cmlist;\n    }\n\n    /**\n     * @param {number|string} courseModuleId\n     * @returns {CourseModule|null}\n     */\n    getCourseModule(courseModuleId) {\n        return this.reactive.state.cm.get(courseModuleId);\n    }\n\n    /**\n     * @param {String} courseModuleId\n     * @returns {String}\n     */\n    getCourseModuleName(courseModuleId) {\n        const courseModule = this.reactive.state.cm.get(courseModuleId);\n\n        return courseModule.name ?? 'Unknown';\n    }\n\n    /**\n     * @param {number|string} sectionId\n     * @param {string} type\n     * @returns {boolean}\n     */\n    hasSectionCourseModuleType(sectionId, type) {\n        let cms = this.getSectionCourseModules(sectionId);\n        if (!cms) {\n            return false;\n        }\n        for (const id of cms) {\n            if (this.isCourseModuleTypeById(id, type)) {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    /**\n     * @param {number|string} courseModuleId\n     * @param {string} type\n     * @returns {boolean}\n     */\n    isCourseModuleTypeById(courseModuleId, type) {\n        const courseModule = this.getCourseModule(courseModuleId);\n        if (!courseModule) {\n            return false;\n        }\n        return courseModule?.module === type;\n    }\n\n    /**\n     * @returns {NodeListOf<HTMLElement>}\n     */\n    getClipboardTargets() {\n        return this.#element.querySelectorAll('.clipboard_target');\n    }\n\n    clearClipboardTargets() {\n        this.getClipboardTargets().forEach((target) => {\n            target.remove();\n        });\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async setClipboard(item) {\n        if (!this.#clipboard) {\n            await this.renderClipboard();\n        }\n        else{\n            await this.reRenderClipboard();\n        }\n\n        this.updateClipboard(item);\n        await this.updateClipboardTargets(item);\n    }\n}\n"],"names":["constructor","baseFactory","blockElement","element","AbortController","reactive","_classPrivateFieldGet","moodle","template","createElementFromTemplate","prepend","this","querySelector","addEventListener","onClearClipboard","bind","e","preventDefault","stopPropagation","clearClipboard","classList","add","clearClipboardTargets","renderClipboard","updateClipboard","item","innerHTML","getItemInfo","remove","abort","querySelectorAll","forEach","section","clipboardTarget","sectionId","matches","courseSectionsElementList","courseSectionElement","isSectionClipboardTargetEligible","cloneNode","closest","dataset","id","parentElement","confirmImportBackupFromSharingCart","signal","isSubsection","isSection","getSectionName","state","get","title","getSectionCourseModules","cmlist","getCourseModule","courseModuleId","cm","getCourseModuleName","name","hasSectionCourseModuleType","type","cms","isCourseModuleTypeById","courseModule","module","getClipboardTargets","target","reRenderClipboard","updateClipboardTargets"],"mappings":"y5CAsFIA,YAAYC,YAAaC,aAAcC,iTAjB1B,kGAK6B,IAAIC,0MAatBH,sDACCC,kDACLC,cACXE,UAAW,8GAIQC,yCAAkBC,SAASC,WAAWC,0BAC1D,4CACA,0CAGUC,8BAAQC,kBAEOL,uCAAgBM,cAAc,mCACtCC,iBACjB,QACAF,KAAKG,iBAAiBC,KAAKJ,OAOnCG,iBAAiBE,GACbA,EAAEC,iBACFD,EAAEE,uBAEGC,iBAGTA,wDACoBC,UAAUC,IAAI,eACzBC,kEAEcH,gDAIdA,uBACCR,KAAKY,kBAMfC,gBAAgBC,6CACIL,UAAUC,IAAI,UAEJf,uCAAgBM,cAAc,SACtCc,UAAYD,KAAKE,cAAcD,iDAEjCN,UAAUQ,OAAO,uCAMRH,YACnBtB,cAAgBG,yCAAkBC,SAASC,WAAWC,0BACxD,mDACA,wEAGyCoB,2EACE,IAAIzB,sDAErC0B,iBAAiB,uDAAuDC,SAASC,wCAEvFC,gBAAkB,KAClBC,UAAY,QAEbF,QAAQG,QAAQ,0CAETC,0BAA4BJ,QAAQF,iBAAiB,2CAEvDM,iCAEJA,0BAA0BL,SAASM,iDAE3B1B,KAAK2B,iCAAiCD,qBAAqBZ,QAE/DQ,8CAAkBI,qBAAqBzB,cAAc,4EAAwBT,QAAQoC,WAAU,GAC/FF,qBAAqB3B,QAAQuB,iBAC7BC,UAAYG,qBAAqBG,QAAQ,wBAAwBC,QAAQC,GAEzET,gBAAgBb,UAAUQ,OAAO,UACjCK,gBAAgBU,cAAcvB,UAAUQ,OAAO,UAC/CK,gBAAgBpB,iBACZ,QACAP,0CAAmBsC,mCAAmC7B,2BAAKJ,oBAAoBc,KAAMS,WACrF,CACIW,OAAQvC,oEAA6CuC,kBAQjElC,KAAK2B,iCAAiCN,QAAQP,QAElDQ,8CAAkBD,QAAQpB,cAAc,4EAAwBT,QAAQoC,WAAU,GAClFP,QAAQtB,QAAQuB,iBAChBC,UAAYF,QAAQQ,QAAQ,wBAAwBC,QAAQC,GAE5DT,gBAAgBb,UAAUQ,OAAO,UACjCK,gBAAgBU,cAAcvB,UAAUQ,OAAO,UAC/CK,gBAAgBpB,iBACZ,QACAP,0CAAmBsC,mCAAmC7B,2BAAKJ,oBAAoBc,KAAMS,WACrF,CACIW,OAAQvC,oEAA6CuC,aAarEP,iCAAiCN,QAAQP,SAGjCO,QAAQpB,cAAc,4BACf,MAGPa,KAAKqB,iBAAmBrB,KAAKsB,YAAa,OAAO,SAEvBf,QAAQQ,QAAQ,iCAWlDQ,eAAed,4DACKvB,KAAKN,SAAS4C,MAAMjB,QAAQkB,IAAIhB,WAEjCiB,+CAAS,UAO5BC,wBAAwBlB,kBACbvB,KAAKN,SAAS4C,MAAMjB,QAAQkB,IAAIhB,WAAWmB,OAOtDC,gBAAgBC,uBACL5C,KAAKN,SAAS4C,MAAMO,GAAGN,IAAIK,gBAOtCE,oBAAoBF,yEACK5C,KAAKN,SAAS4C,MAAMO,GAAGN,IAAIK,gBAE5BG,sDAAQ,UAQhCC,2BAA2BzB,UAAW0B,UAC9BC,IAAMlD,KAAKyC,wBAAwBlB,eAClC2B,WACM,MAEN,MAAMnB,MAAMmB,OACTlD,KAAKmD,uBAAuBpB,GAAIkB,aACzB,SAGR,EAQXE,uBAAuBP,eAAgBK,YAC7BG,aAAepD,KAAK2C,gBAAgBC,wBACrCQ,eAGEA,MAAAA,oBAAAA,aAAcC,UAAWJ,KAMpCK,6BACW3D,qCAAcwB,iBAAiB,qBAG1CR,6BACS2C,sBAAsBlC,SAASmC,SAChCA,OAAOtC,+BAOIH,4BACVd,uBAIKA,KAAKwD,0BAHLxD,KAAKY,uBAMVC,gBAAgBC,YACfd,KAAKyD,uBAAuB3C"}