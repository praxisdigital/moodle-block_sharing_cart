{"version":3,"file":"element.min.js","sources":["../../../src/app/block/element.js"],"sourcesContent":["import Sortable from '../../lib/sortablejs';\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport {get_string, get_strings} from \"core/str\";\nimport Ajax from \"core/ajax\";\nimport Notification from \"core/notification\";\n\n/**\n * @typedef BackupSettings\n * @property {boolean} users - Whether to backup user data.\n * @property {boolean} anonymize - Whether to anonymize user data.\n */\n\nexport default class BlockElement {\n    /**\n     * @type {BaseFactory}\n     */\n    #baseFactory;\n\n    /**\n     * @type {HTMLElement}\n     */\n    #element;\n\n    /**\n     * @type {CourseElement}\n     */\n    #course;\n\n    /**\n     * @type {QueueElement}\n     */\n    #queue;\n\n    /**\n     * @type {ItemElement[]}\n     */\n    #items = [];\n\n    /**\n     * @type {Sortable|NULL}\n     */\n    #sortable = null;\n\n    /**\n     * @type {ItemElement|NULL}\n     */\n    #clipboardItem = null;\n\n    /**\n     * @type {Boolean}\n     */\n    #canBackupUserdata = false;\n\n    /**\n     * @type {boolean}\n     */\n    #canBackup = false;\n\n    /**\n     * @type {Boolean}\n     */\n    #canAnonymizeUserdata = false;\n\n    /**\n     * @type {Boolean}\n     */\n    #showSharingCartBasket = false;\n\n    /**\n     * @type {Number|null}\n     */\n    #draggedCourseModuleId = null;\n\n    /**\n     * @type {Number|null}\n     */\n    #draggedSectionId = null;\n\n    /**\n     * @type {boolean}\n     */\n    #bulkDeleteEnabled = false;\n\n    /**\n     * @param {BaseFactory} baseFactory\n     * @param {HTMLElement} element\n     * @param {Boolean} canBackupUserdata\n     * @param {Boolean} canAnonymizeUserdata\n     * @param {Boolean} canBackup\n     * @param {Boolean} showSharingCartBasket\n     */\n    constructor(baseFactory, element, canBackupUserdata, canAnonymizeUserdata, canBackup, showSharingCartBasket) {\n        this.#baseFactory = baseFactory;\n        this.#element = element;\n        this.#canBackupUserdata = canBackupUserdata;\n        this.#canAnonymizeUserdata = canAnonymizeUserdata;\n        this.#canBackup = canBackup;\n        this.#showSharingCartBasket = showSharingCartBasket;\n    }\n\n    /**\n     * @return {{course: CourseElement, block: BlockElement, queue: QueueElement}}\n     */\n    addEventListeners() {\n        this.setupCourse();\n        this.setupQueue();\n        this.setupItems();\n        this.setupDragAndDrop();\n        this.setupBulkDelete();\n\n        return {course: this.#course, queue: this.#queue, block: this};\n    }\n\n    setupCourse() {\n        const course = document.querySelector('.course-content');\n\n        this.#course = this.#baseFactory.block().course().element(this, course);\n    }\n\n    setupQueue() {\n        const queue = document.querySelector('.sharing_cart_queue');\n\n        this.#queue = this.#baseFactory.block().queue().element(this, queue);\n    }\n\n    async setupItems() {\n        const items = this.#element.querySelectorAll('.sharing_cart_item');\n\n        for (const element of items) {\n            await this.setupItem(element);\n        }\n\n        this.#sortable = new Sortable(this.#element.querySelector('.sharing_cart_items'), {\n            dataIdAttr: 'data-itemid',\n            draggable: '.sharing_cart_item',\n            onUpdate: () => {\n                Ajax.call([{\n                    methodname: 'block_sharing_cart_reorder_sharing_cart_items',\n                    args: {\n                        item_ids: this.#sortable.toArray().filter((id) => !isNaN(id)),\n                    },\n                    fail: (data) => {\n                        Notification.exception(data);\n                    }\n                }]);\n            }\n        });\n    }\n\n    setupDragAndDrop() {\n        if (!this.#canBackup) {\n            return;\n        }\n\n        const dropZone = this.#element;\n\n        dropZone.addEventListener('dragover', (e) => {\n            if (!this.#draggedSectionId && !this.#draggedCourseModuleId) {\n                return;\n            }\n\n            e.preventDefault();\n            e.stopPropagation();\n        });\n        dropZone.addEventListener('dragleave', (e) => {\n            if (!this.#draggedSectionId && !this.#draggedCourseModuleId) {\n                return;\n            }\n\n            e.preventDefault();\n            e.stopPropagation();\n        });\n        dropZone.addEventListener('drop', async (e) => {\n            if (!this.#draggedSectionId && !this.#draggedCourseModuleId) {\n                return;\n            }\n\n            e.preventDefault();\n            e.stopPropagation();\n\n            if (this.#draggedSectionId) {\n                await this.addSectionBackupToSharingCart(this.#draggedSectionId);\n            } else if (this.#draggedCourseModuleId) {\n                await this.addCourseModuleBackupToSharingCart(this.#draggedCourseModuleId);\n            }\n        });\n    }\n\n    setupBulkDelete() {\n        const enableBulkDeleteButton = this.#element.querySelector('#block_sharing_cart_bulk_delete');\n        const disableBulkDeleteButton = this.#element.querySelector('#block_sharing_cart_cancel_bulk_delete');\n        const bulkDeleteButton = this.#element.querySelector('#block_sharing_cart_bulk_delete_confirm');\n\n        const selectAllContainer = this.#element.querySelector('#select_all_container');\n        const selectAllCheckbox = this.#element.querySelector('#select_all_box');\n\n        selectAllCheckbox.addEventListener('click', async () => {\n            const itemCheckboxes = this.getItemCheckboxes();\n            const allSelected = Array.from(itemCheckboxes).every(checkbox => checkbox.checked);\n            itemCheckboxes.forEach(checkbox => {\n                checkbox.checked = !allSelected;\n            });\n            itemCheckboxes.forEach(checkbox => checkbox.addEventListener('change', async () => {\n                this.updateSelectAllState();\n            }));\n\n            this.updateSelectAllState();\n            this.updateBulkDeleteButtonState();\n        });\n\n        enableBulkDeleteButton.addEventListener('click', () => {\n            if (this.#items.length === 0) {\n                return;\n            }\n\n            this.#bulkDeleteEnabled = true;\n\n            enableBulkDeleteButton.classList.add('d-none');\n            disableBulkDeleteButton.classList.remove('d-none');\n\n            selectAllContainer.classList.remove('d-none');\n            bulkDeleteButton.classList.remove('d-none');\n\n            this.getItemCheckboxes().forEach((checkbox) => {\n                checkbox.classList.remove('d-none');\n            });\n        });\n\n        disableBulkDeleteButton.addEventListener('click', () => {\n            disableBulkDeleteButton.classList.add('d-none');\n            bulkDeleteButton.classList.add('d-none');\n            bulkDeleteButton.disabled = true;\n            enableBulkDeleteButton.classList.remove('d-none');\n            selectAllContainer.classList.add('d-none');\n            this.#bulkDeleteEnabled = false;\n\n            this.getItemCheckboxes().forEach((checkbox) => {\n                checkbox.classList.add('d-none');\n                checkbox.checked = false;\n            });\n            this.updateSelectAllState();\n        });\n\n        bulkDeleteButton.addEventListener('click', async () => {\n            if (bulkDeleteButton.disabled) {\n                return;\n            }\n\n            const itemIds = [];\n            this.getItemCheckboxes().forEach((checkbox) => {\n                if (!checkbox.checked) {\n                    return;\n                }\n\n                itemIds.push(checkbox.value);\n            });\n\n            await this.confirmDeleteItems(itemIds);\n        });\n    }\n\n    /**\n     * @param {HTMLElement} element\n     */\n    async setupItem(element) {\n        const itemElement = this.#baseFactory.block().item().element(this, element);\n\n        if (itemElement.getStatus() !== '0' && this.isBulkDeleteEnabled()) {\n            const checkbox = element.querySelector('input[data-action=\"bulk_select\"][type=\"checkbox\"]');\n            checkbox?.classList?.remove('d-none');\n        }\n\n        this.#element.querySelector('.no-items').classList.add('d-none');\n        this.#element.querySelector('.has-items').classList.remove('d-none');\n\n        const rootItems = this.#element.querySelectorAll('.sharing_cart_items > .sharing_cart_item');\n        if (this.#bulkDeleteEnabled === false && rootItems.length > 1) {\n            this.#element.querySelector('#block_sharing_cart_bulk_delete').classList.remove('d-none');\n        }\n\n        const existingItemIndex = this.#items.findIndex((i) => i.getItemId() === itemElement.getItemId());\n        if (existingItemIndex !== -1) {\n            this.#items[existingItemIndex] = itemElement;\n        } else {\n            this.#items.push(itemElement);\n        }\n\n        this.updateBulkDeleteButtonState();\n        this.updateSelectAllState();\n    }\n\n    getItemCheckboxes() {\n        const checkboxSelector = '.sharing_cart_item:not([data-status=\"0\"]) input[data-action=\"bulk_select\"][type=\"checkbox\"]';\n        return this.#element.querySelectorAll(checkboxSelector);\n    }\n\n    updateBulkDeleteButtonState() {\n        const bulkDeleteButton = this.#element.querySelector('#block_sharing_cart_bulk_delete_confirm');\n        bulkDeleteButton.disabled = !Array.from(this.getItemCheckboxes()).some(checkbox => checkbox.checked);\n    }\n\n    updateSelectAllState() {\n        const selectAllCheckbox = this.#element.querySelector('#select_all_box');\n        const selectAllLabel = this.#element.querySelector('#select_all_label');\n\n        const itemCheckboxes = this.getItemCheckboxes();\n        const allSelected = Array.from(itemCheckboxes).every(checkbox => checkbox.checked);\n        const someSelected = Array.from(itemCheckboxes).some(checkbox => checkbox.checked);\n\n        const strPromise = allSelected ?\n            get_string('deselect_all', 'block_sharing_cart') :\n            get_string('select_all', 'block_sharing_cart');\n        strPromise.then((str) => {\n            selectAllLabel.textContent = str;\n        });\n\n        selectAllCheckbox.checked = allSelected;\n        selectAllCheckbox.indeterminate = !allSelected && someSelected;\n    }\n\n    isBulkDeleteEnabled() {\n        return this.#bulkDeleteEnabled;\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async setClipboard(item) {\n        this.#clipboardItem = item;\n\n        await this.#course.setClipboard(item);\n    }\n\n    clearClipboard() {\n        this.#clipboardItem = null;\n    }\n\n    /**\n     * @param {Number|null} id\n     */\n    setDraggedSectionId(id) {\n        this.#draggedSectionId = id;\n    }\n\n    /**\n     * @param {Number|null} id\n     */\n    setDraggedCourseModuleId(id) {\n        this.#draggedCourseModuleId = id;\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    async removeItemElement(item) {\n        const childItems = item.getItemChildrenRecursively();\n        childItems.forEach((childItem) => {\n            const index = this.#items.findIndex((i) => i.getItemId() === Number.parseInt(childItem.dataset.itemid));\n            if (index === -1) {\n                return;\n            }\n\n            if (this.#items[index].getItemId() === this.#clipboardItem?.getItemId()) {\n                this.#course.clearClipboard();\n            }\n\n            this.#items.splice(index, 1);\n            childItem.remove();\n        });\n\n        const index = this.#items.findIndex((i) => i.getItemId() === item.getItemId());\n        if (this.#items[index].getItemId() === this.#clipboardItem?.getItemId()) {\n            this.#course.clearClipboard();\n        }\n\n        this.#items.splice(index, 1);\n        item.remove();\n\n        if (this.#items.length === 0) {\n            this.#element.querySelector('.no-items').classList.remove('d-none');\n            this.#element.querySelector('.has-items').classList.add('d-none');\n        }\n\n        const rootItems = this.#element.querySelectorAll('.sharing_cart_items > .sharing_cart_item');\n        if (rootItems.length < 2) {\n            this.hideBulkDelete();\n        }\n    }\n\n    hideBulkDelete() {\n        this.#bulkDeleteEnabled = false;\n        this.#element.querySelector('#block_sharing_cart_cancel_bulk_delete').classList.add('d-none');\n        this.#element.querySelector('#block_sharing_cart_bulk_delete_confirm').classList.add('d-none');\n        this.#element.querySelector('#block_sharing_cart_bulk_delete').classList.add('d-none');\n        this.#element.querySelector('#select_all_container').classList.add('d-none');\n\n        this.getItemCheckboxes().forEach((checkbox) => {\n            checkbox.classList.add('d-none');\n            checkbox.checked = false;\n        });\n        this.updateSelectAllState();\n    }\n\n    /**\n     * @param {ItemElement} item\n     */\n    deleteItem(item) {\n        Ajax.call([{\n            methodname: 'block_sharing_cart_delete_item_from_sharing_cart',\n            args: {\n                item_id: item.getItemId(),\n            },\n            done: async (deleted) => {\n                if (deleted) {\n                    await this.removeItemElement(item);\n                    this.updateSelectAllState();\n                } else {\n                    await Notification.alert('Failed to delete item');\n                }\n            },\n            fail: (data) => {\n                Notification.exception(data);\n            }\n        }]);\n    }\n\n    /**\n     * @param {Array<Number>} itemIds\n     */\n    deleteItems(itemIds) {\n        itemIds = itemIds.map((id) => Number.parseInt(id));\n\n        Ajax.call([{\n            methodname: 'block_sharing_cart_delete_items_from_sharing_cart',\n            args: {\n                item_ids: itemIds,\n            },\n            done: async (deletedItemIds) => {\n                const items = this.#items.filter((i) => itemIds.includes(i.getItemId()));\n                for (const item of items) {\n                    const deleted = deletedItemIds.includes(item.getItemId());\n                    if (!deleted) {\n                        Notification.alert('Failed to delete item: \"' + item.getItemName() + '\"');\n                        continue;\n                    }\n\n                    await this.removeItemElement(item);\n                }\n                this.updateSelectAllState();\n\n                document.getElementById('block_sharing_cart_bulk_delete_confirm').disabled = true;\n            },\n            fail: (data) => {\n                Notification.exception(data);\n            }\n        }]);\n    }\n\n    getElement() {\n        return this.#element;\n    }\n\n    /**\n     * @param {number} courseModuleId\n     * @param {string} name\n     * @param {(BackupSettings) => void} onSave\n     * @returns {Promise<Modal>}\n     */\n    async createBackupCourseModuleToSharingCartModal(courseModuleId, name, onSave) {\n        return this.createBackupItemToSharingCartModal('module', courseModuleId, name, onSave);\n    }\n\n    /**\n     * @param {number} sectionId\n     * @param {string} name\n     * @param {(BackupSettings) => void} onSave\n     * @returns {Promise<Modal>}\n     */\n    async createBackupSectionToSharingCartModal(sectionId, name, onSave) {\n        return this.createBackupItemToSharingCartModal('section', sectionId, name, onSave);\n    }\n\n    /**\n     * @param {string} backupType\n     * @param {number} itemId\n     * @returns {boolean}\n     */\n    #hasQuiz(backupType, itemId) {\n        if (backupType === 'section') {\n            return this.#course.hasSectionCourseModuleType(itemId, 'quiz');\n        }\n        return this.#course.isCourseModuleTypeById(itemId, 'quiz');\n    }\n\n    /**\n     * @param {string} backupType\n     * @param {number} itemId\n     * @param {string} itemName\n     * @param {(BackupSettings) => void} onSave\n     * @return {Promise<Modal>}\n     */\n    async createBackupItemToSharingCartModal(backupType, itemId, itemName, onSave) {\n        const strings = await get_strings([\n            {\n                key: 'backup_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'into_sharing_cart',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'copy',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const {html, js} = await this.#baseFactory.moodle().template().renderTemplate(\n            'block_sharing_cart/modal/backup_to_sharing_cart_modal_body',\n            {\n                has_quiz: this.#hasQuiz(backupType, itemId),\n                show_user_data_backup: this.#canBackupUserdata,\n                show_anonymize_user_data: this.#canBackupUserdata && this.#canAnonymizeUserdata,\n            }\n        );\n\n        /**\n         * @type {Modal}\n         */\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0] + ': \"' + itemName.slice(0, 50).trim() + '\" ' + strings[1],\n            body: html,\n            buttons: {\n                save: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n        modal.getRoot().on(ModalEvents.shown, () => this.#baseFactory.moodle().template().runTemplateJS(js));\n        modal.getRoot().on(ModalEvents.save, () => {\n            const modalUserdataCheckbox = document.getElementById('modal-userdata-checkbox');\n            const modalAnonymizeCheckbox = document.getElementById('modal-anonymize-checkbox');\n            onSave({\n                users: modalUserdataCheckbox?.checked ?? false,\n                anonymize: modalAnonymizeCheckbox?.checked ?? false\n            });\n        });\n\n        return modal;\n    }\n\n    /**\n     * @param {Number} sectionId\n     */\n    async addSectionBackupToSharingCart(sectionId) {\n        const sectionName = this.#course.getSectionName(sectionId);\n\n        const cms = this.#course.getSectionCourseModules(sectionId);\n\n        if (cms.length === 0) {\n            const strings = await get_strings([\n                {\n                    key: 'no_course_modules_in_section',\n                    component: 'block_sharing_cart',\n                },\n                {\n                    key: 'no_course_modules_in_section_description',\n                    component: 'block_sharing_cart',\n                },\n            ]);\n\n            await Notification.alert(strings[0], strings[1]);\n\n            return;\n        }\n\n        const saver = (settings) => {\n            Ajax.call([{\n                methodname: 'block_sharing_cart_backup_section_into_sharing_cart',\n                args: {\n                    section_id: sectionId,\n                    settings: settings\n                },\n                done: async (data) => {\n                    await this.renderItem(data);\n                },\n                fail: (data) => {\n                    Notification.exception(data);\n                }\n            }]);\n        };\n\n        const modal = await this.createBackupSectionToSharingCartModal(\n            sectionId,\n            sectionName,\n            saver\n        );\n        await modal.show();\n    }\n\n    /**\n     * @param {Number} courseModuleId\n     */\n    async addCourseModuleBackupToSharingCart(courseModuleId) {\n        const courseModuleName = this.#course.getCourseModuleName(courseModuleId);\n        const saver = (settings) => {\n            Ajax.call([{\n                methodname: 'block_sharing_cart_backup_course_module_into_sharing_cart',\n                args: {\n                    course_module_id: courseModuleId,\n                    settings: settings\n                },\n                done: async (data) => {\n                    await this.renderItem(data);\n                },\n                fail: (data) => {\n                    Notification.exception(data);\n                }\n            }]);\n        };\n        const modal = await this.createBackupCourseModuleToSharingCartModal(\n            courseModuleId,\n            courseModuleName,\n            saver\n        );\n        await modal.show();\n    }\n\n    /**\n     * @param {Object} item\n     */\n    async renderItem(item) {\n        const existingItemIndex = this.#items.findIndex((i) => i.getItemId() === item.id);\n        const existingItem = this.#items[existingItemIndex] ?? false;\n        const getOldElement = () => {\n            return this.#element.querySelector('.sharing_cart_items .sharing_cart_item[data-itemid=\"' + item.id + '\"]');\n        };\n        const oldElement = getOldElement();\n        if (existingItem && oldElement) {\n            const element = await this.#baseFactory.moodle().template().createElementFromFragment(\n                'block_sharing_cart',\n                'item',\n                M.cfg.courseContextId,\n                {\n                    item_id: item.id,\n                }\n            );\n\n            // Early exit if the element has been removed from the DOM in between rendering and checking earlier.\n            if (getOldElement() !== oldElement) {\n                return;\n            }\n\n            this.#element.querySelector('.sharing_cart_items').replaceChild(element, oldElement);\n            this.#items[existingItemIndex] = this.#baseFactory.block().item().element(this, element);\n\n            await this.setupItem(element);\n            for (const subItem of element.querySelectorAll('.sharing_cart_item')) {\n                await this.setupItem(subItem);\n            }\n\n            return;\n        }\n\n        const element = await this.#baseFactory.moodle().template().createElementFromTemplate(\n            'block_sharing_cart/block/item',\n            {\n                id: item.id,\n                name: item.name,\n                type: item.type,\n                status: 0,\n                old_instance_id: item.old_instance_id,\n                status_awaiting: true,\n                show_run_now: false,\n                can_copy_to_course: item.can_copy_to_course ?? false,\n                task_id: item.task_id ?? null,\n                status_finished: false,\n                status_failed: false,\n                is_module: item.type !== 'section',\n                is_section: item.type === 'section',\n                is_root: true,\n            }\n        );\n        this.#element.querySelector('.sharing_cart_items').prepend(element);\n\n        await this.setupItem(element);\n    }\n\n    /**\n     * @param {ItemElement} item\n     * @param {Number} sectionId\n     * @param {HTMLElement} modal\n     */\n    importItem(item, sectionId, modal) {\n        this.#course.clearClipboard();\n\n        const courseModuleIds = [];\n        modal.querySelectorAll('input[type=\"checkbox\"][data-type=\"coursemodule\"]:checked').forEach((checkbox) => {\n            courseModuleIds.push(checkbox.dataset.id);\n        });\n\n        if (item.isSection() && courseModuleIds.length === 0) {\n            modal.querySelectorAll('.form-check-input').forEach(async (item) => {\n                item.setCustomValidity(\n                    await get_string('atleast_one_course_module_must_be_included', 'block_sharing_cart')\n                );\n                item.reportValidity();\n            });\n            return false;\n        }\n\n        if (item.isModule()) {\n            courseModuleIds.push(item.getItemOldInstanceId());\n        }\n\n        Ajax.call([{\n            methodname: 'block_sharing_cart_restore_item_from_sharing_cart_into_section',\n            args: {\n                item_id: item.getItemId(),\n                section_id: sectionId,\n                course_modules_to_include: courseModuleIds,\n            },\n            done: async (success) => {\n                if (success) {\n                    await this.#queue.loadQueue(true);\n                }\n            },\n            fail: (data) => {\n                Notification.exception(data);\n            }\n        }]);\n    }\n\n    /**\n     * @param {ItemElement} item\n     * @param {Number} sectionId\n     * @param {Event} e\n     */\n    async confirmImportBackupFromSharingCart(item, sectionId, e) {\n        e.preventDefault();\n        e.stopPropagation();\n\n        const strings = await get_strings([\n            {\n                key: 'copy_item',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'into_section',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'copy',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const sectionName = this.#course.getSectionName(sectionId);\n        const divElement = document.getElementById('block_sharing_cart');\n        const pageContextId = divElement.getAttribute('data-contextid');\n\n        const {html, js} = await this.#baseFactory.moodle().template().renderFragment(\n            'block_sharing_cart',\n            'item_restore_form',\n            pageContextId,\n            {\n                item_id: item.getItemId()\n            }\n        );\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.SAVE_CANCEL,\n            title: strings[0] + ': ' +\n                '\"' + item.getItemName().slice(0, 50).trim() + '\"' +\n                ' ' + strings[1] + ': ' +\n                '\"' + sectionName.slice(0, 50).trim() + '\"',\n            body: html,\n            buttons: {\n                save: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n        modal.getRoot().on(ModalEvents.shown, () => this.#baseFactory.moodle().template().runTemplateJS(js));\n        modal.getRoot().on(ModalEvents.save, this.importItem.bind(this, item, sectionId, modal.getRoot()[0]));\n        await modal.show();\n    }\n\n    /**\n     * @param {Array<Number>} itemIds\n     */\n    async confirmDeleteItems(itemIds) {\n        const strings = await get_strings([\n            {\n                key: 'delete_items',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'confirm_delete_items',\n                component: 'block_sharing_cart',\n            },\n            {\n                key: 'delete',\n                component: 'core',\n            },\n            {\n                key: 'cancel',\n                component: 'core',\n            }\n        ]);\n\n        const modal = await ModalFactory.create({\n            type: ModalFactory.types.DELETE_CANCEL,\n            title: strings[0],\n            body: strings[1],\n            buttons: {\n                delete: strings[2],\n                cancel: strings[3],\n            },\n            removeOnClose: true,\n        });\n\n        modal.getRoot().on(ModalEvents.delete, this.deleteItems.bind(this, itemIds));\n        await modal.show();\n    }\n}\n"],"names":["backupType","itemId","_classPrivateFieldGet","hasSectionCourseModuleType","isCourseModuleTypeById","constructor","baseFactory","element","canBackupUserdata","canAnonymizeUserdata","canBackup","showSharingCartBasket","addEventListeners","setupCourse","setupQueue","setupItems","setupDragAndDrop","setupBulkDelete","course","this","queue","block","document","querySelector","items","querySelectorAll","setupItem","Sortable","dataIdAttr","draggable","onUpdate","call","methodname","args","item_ids","toArray","filter","id","isNaN","fail","data","exception","dropZone","addEventListener","e","preventDefault","stopPropagation","async","addSectionBackupToSharingCart","addCourseModuleBackupToSharingCart","enableBulkDeleteButton","disableBulkDeleteButton","bulkDeleteButton","selectAllContainer","itemCheckboxes","getItemCheckboxes","allSelected","Array","from","every","checkbox","checked","forEach","updateSelectAllState","updateBulkDeleteButtonState","length","classList","add","remove","disabled","itemIds","push","value","confirmDeleteItems","itemElement","item","getStatus","isBulkDeleteEnabled","rootItems","existingItemIndex","findIndex","i","getItemId","some","selectAllCheckbox","selectAllLabel","someSelected","then","str","textContent","indeterminate","setClipboard","clearClipboard","setDraggedSectionId","setDraggedCourseModuleId","getItemChildrenRecursively","childItem","index","Number","parseInt","dataset","itemid","_classPrivateFieldGet2","splice","_classPrivateFieldGet3","hideBulkDelete","deleteItem","item_id","done","deleted","removeItemElement","Notification","alert","deleteItems","map","includes","deletedItemIds","getItemName","getElementById","getElement","courseModuleId","name","onSave","createBackupItemToSharingCartModal","sectionId","itemName","strings","key","component","html","js","moodle","template","renderTemplate","has_quiz","show_user_data_backup","show_anonymize_user_data","modal","ModalFactory","create","type","types","SAVE_CANCEL","title","slice","trim","body","buttons","save","cancel","removeOnClose","getRoot","on","ModalEvents","shown","runTemplateJS","modalUserdataCheckbox","modalAnonymizeCheckbox","users","anonymize","sectionName","getSectionName","getSectionCourseModules","createBackupSectionToSharingCartModal","settings","section_id","renderItem","show","courseModuleName","getCourseModuleName","createBackupCourseModuleToSharingCartModal","course_module_id","existingItem","getOldElement","oldElement","createElementFromFragment","M","cfg","courseContextId","replaceChild","subItem","createElementFromTemplate","status","old_instance_id","status_awaiting","show_run_now","can_copy_to_course","task_id","status_finished","status_failed","is_module","is_section","is_root","prepend","importItem","courseModuleIds","isSection","setCustomValidity","reportValidity","isModule","getItemOldInstanceId","course_modules_to_include","success","loadQueue","pageContextId","getAttribute","renderFragment","bind","DELETE_CANCEL","delete"],"mappings":"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"}